# Библиотечная система управления

RESTful API для управления библиотечным каталогом, построенное на FastAPI и SQLite.

## Содержание
- [Установка и запуск](#установка-и-запуск)
- [Структура проекта](#структура-проекта)
- [Архитектура базы данных](#архитектура-базы-данных)
- [Бизнес-логика](#бизнес-логика)
- [Аутентификация](#аутентификация)
- [Дополнительные возможности](#дополнительные-возможности)

## Установка и запуск

### Локальная установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd library-management
```

2. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Для Linux/Mac
# или
venv\Scripts\activate  # Для Windows
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Запустите приложение:
```bash
uvicorn app.main:app --reload
```

Приложение будет доступно по адресу: `http://localhost:8000`

### Запуск через Docker

1. Соберите Docker образ:
```bash
docker build -t library-management .
```

2. Запустите контейнер:
```bash
docker run -d -p 8000:8000 library-management
```

### CI/CD с GitHub Actions

Проект настроен для автоматической сборки и тестирования через GitHub Actions. При пуше в main ветку:

1. Запускаются автоматические тесты
2. Собирается Docker образ
3. Образ публикуется в GitHub Container Registry

Для использования CI/CD:

1. Форкните репозиторий
2. Включите GitHub Actions в настройках репозитория
3. Настройте секреты для доступа к GitHub Container Registry:
   - `GHCR_USERNAME`
   - `GHCR_TOKEN`

### Регистрация первого пользователя

1. Откройте Swagger UI: `http://localhost:8000/docs`
2. Найдите эндпоинт POST `/register`
3. Введите данные в формате:
```json
{
    "email": "your@email.com",
    "password": "your_password"
}
```
4. После успешной регистрации используйте эндпоинт POST `/token` для получения JWT токена
5. Используйте полученный токен для доступа к защищенным эндпоинтам

## Структура проекта

```
library-management/
├── app/
│   ├── __init__.py
│   ├── main.py          # Основной файл приложения
│   ├── models.py        # Модели SQLAlchemy
│   ├── schemas.py       # Pydantic схемы
│   ├── auth.py          # Логика аутентификации
│   └── database.py      # Конфигурация БД
├── tests/
│   └── test_library.py  # Тесты
├── requirements.txt
└── README.md
```

## Архитектура базы данных

База данных построена на SQLite с использованием SQLAlchemy ORM. Основные таблицы:

1. `users` - библиотекари
   - id (PK)
   - email (unique)
   - hashed_password

2. `books` - книги
   - id (PK)
   - title
   - author
   - copies_available

3. `readers` - читатели
   - id (PK)
   - name
   - email (unique)

4. `borrowed_books` - выданные книги
   - id (PK)
   - book_id (FK)
   - reader_id (FK)
   - borrow_date
   - return_date

Принятые решения:
- Использование SQLite для простоты развертывания
- Отслеживание количества экземпляров в таблице books
- Отдельная таблица для выданных книг с датами выдачи/возврата

## Бизнес-логика

### 4.1 Выдача книг
Реализовано через эндпоинт POST `/borrow/`:
- Проверка наличия экземпляров (copies_available > 0)
- Уменьшение количества экземпляров при выдаче
- Фиксация даты выдачи

Сложности и решения:
- Атомарность операции: использование транзакций SQLAlchemy
- Конкурентный доступ: блокировка на уровне БД

### 4.2 Ограничение количества книг
Реализовано в эндпоинте POST `/borrow/`:
- Подсчет активных выдач для читателя
- Проверка лимита в 3 книги
- Отказ в выдаче при превышении лимита

Сложности и решения:
- Производительность: оптимизация запроса подсчета книг
- Консистентность: проверка в рамках транзакции

### 4.3 Возврат книг
Реализовано через эндпоинт POST `/return/{borrow_id}`:
- Проверка существования записи о выдаче
- Проверка, что книга еще не возвращена
- Увеличение количества экземпляров
- Фиксация даты возврата

Сложности и решения:
- Валидация состояния: проверка return_date
- Атомарность: использование транзакций

## Аутентификация

### Реализация
- JWT токены с использованием python-jose
- Хеширование паролей через passlib[bcrypt]
- Время жизни токена: 30 минут

### Защищенные эндпоинты
- Все эндпоинты кроме:
  - POST `/register`
  - POST `/token`
  - GET `/books/` (публичный доступ)

### Используемые библиотеки
- python-jose: для работы с JWT
- passlib[bcrypt]: для хеширования паролей
- fastapi.security: для интеграции с FastAPI

## Дополнительные возможности

### Система уведомлений
Предлагаемая дополнительная фича: система уведомлений для читателей о:
- Просроченных книгах
- Доступности зарезервированных книг
- Новых поступлениях по интересующим жанрам

Реализация:
1. Добавить таблицу `notifications` для хранения уведомлений
2. Создать фоновую задачу для проверки просрочек
3. Добавить систему подписок на уведомления
4. Реализовать отправку через email/SMS
